generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --------------------------------------
// 1. انواع داده‌ها (Enums)
// --------------------------------------

enum Role {
  SUPER_ADMIN
  ADMIN
  STAFF
}

enum DeviceType {
  PS4
  PS5
  XBOX
  PC
  OTHER
}

enum TransactionType {
  DEPOSIT // واریز به کیف پول
  USAGE // استفاده برای بازی یا بوفه
  REFUND // برگشت وجه
}

enum PaymentMethod {
  CASH
  POS
  CARD_TO_CARD
  WALLET
}

enum SubscriptionStatus {
  ACTIVE
  TRIAL
  EXPIRED
}

// --------------------------------------
// 2. مدیریت کاربران و دسترسی (Auth)
// --------------------------------------

model User {
  id          String   @id @default(cuid())
  name        String?
  email       String?  @unique
  phoneNumber String?  @unique
  password    String?
  role        Role     @default(ADMIN)
  createdAt   DateTime @default(now())

  gameNetId String?
  gameNet   GameNet? @relation(fields: [gameNetId], references: [id], onDelete: Cascade)

  accounts               Account[]
  sessions               Session[]
  startedGameSessions    GameSession[] @relation("StartedBy")
  soldProducts           Order[]       @relation("SoldBy")
  registeredTransactions Transaction[] @relation("RegisteredBy")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --------------------------------------
// 3. سیستم اشتراک و پلن‌ها (SaaS Logic)
// --------------------------------------

model Plan {
  id           String  @id @default(cuid())
  name         String
  price        Decimal
  durationDays Int
  limitSystems Int     @default(-1)
  limitBuffet  Int     @default(-1)
  features     String? @db.Text
  isDefault    Boolean @default(false)

  subscriptions Subscription[]
}

model Subscription {
  id        String             @id @default(cuid())
  startDate DateTime           @default(now())
  endDate   DateTime
  status    SubscriptionStatus @default(ACTIVE)

  planId String
  plan   Plan   @relation(fields: [planId], references: [id])

  gameNetId String  @unique
  gameNet   GameNet @relation(fields: [gameNetId], references: [id], onDelete: Cascade)
}

// --------------------------------------
// 4. مدل اصلی کسب‌وکار (گیم‌نت)
// --------------------------------------

model GameNet {
  id               String        @id @default(cuid())
  name             String
  isActive         Boolean       @default(true)
  dataDeletionDate DateTime?
  subscription     Subscription?

  users        User[]
  products     Product[]
  customers    Customer[]
  gameSessions GameSession[]
  devices      Device[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders       Order[]
  transactions Transaction[]
  settings     Settings?

  services Service[]
}

// --------------------------------------
// 5. دستگاه‌ها و نشست‌های بازی
// --------------------------------------

model Device {
  id         String    @id @default(cuid())
  name       String
  type       String
  hourlyRate Int       @default(0)
  extraRate  Int       @default(0)
  status     String    @default("AVAILABLE")
  startTime  DateTime?

  gameNetId String
  gameNet   GameNet @relation(fields: [gameNetId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions GameSession[]
}

model GameSession {
  id            String @id @default(cuid())
  stationNumber Int
  status        String @default("ACTIVE")

  deviceId String?
  device   Device? @relation(fields: [deviceId], references: [id])

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  gameNetId String
  gameNet   GameNet @relation(fields: [gameNetId], references: [id], onDelete: Cascade)

  startTime   DateTime  @default(now())
  endTime     DateTime?
  startedById String?
  startedBy   User?     @relation("StartedBy", fields: [startedById], references: [id])

  totalPrice      Int?
  durationMinutes Int?

  isPaid        Boolean        @default(false)
  paymentMethod PaymentMethod?

  orders Order[]

  extraControllers Int            @default(0)
  limitMinutes     Int?
  events           SessionEvent[]

  createdAt DateTime         @default(now())
  services  SessionService[]
}

model SessionEvent {
  id        String      @id @default(cuid())
  sessionId String
  session   GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  type       String
  count      Int
  happenedAt DateTime @default(now())
}

// --------------------------------------
// 6. بوفه و سفارشات
// --------------------------------------

model Product {
  id        String @id @default(cuid())
  name      String
  buyPrice  Int
  sellPrice Int
  stock     Int    @default(0)

  gameNetId String
  gameNet   GameNet @relation(fields: [gameNetId], references: [id], onDelete: Cascade)

  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  gameNetId String
  gameNet   GameNet @relation(fields: [gameNetId], references: [id], onDelete: Cascade)

  soldById String
  soldBy   User   @relation("SoldBy", fields: [soldById], references: [id])

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id])

  gameSessionId String?
  gameSession   GameSession? @relation(fields: [gameSessionId], references: [id])

  items OrderItem[]
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  quantity Int

  buyPriceSnapshot  Int
  sellPriceSnapshot Int

  totalPrice Int @default(0)
}

// --------------------------------------
// 7. مشتریان و مالی
// --------------------------------------

enum CustomerRank {
  BRONZE
  SILVER
  GOLD
  PALLADIUM
}

model Customer {
  id          String    @id @default(cuid())
  name        String
  phoneNumber String
  email       String?
  birthDate   DateTime?
  balance     Int       @default(0)

  // VIP System Fields
  rank         CustomerRank @default(BRONZE)
  totalSpent   Int          @default(0)
  totalMinutes Int          @default(0)

  gameNetId String
  gameNet   GameNet @relation(fields: [gameNetId], references: [id], onDelete: Cascade)

  gameSessions GameSession[]
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orders    Order[]

  @@unique([gameNetId, phoneNumber])
}

model Transaction {
  id          String          @id @default(cuid())
  amount      Int
  type        TransactionType
  method      PaymentMethod   @default(CASH)
  description String?

  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  gameNetId String
  gameNet   GameNet @relation(fields: [gameNetId], references: [id], onDelete: Cascade)

  registeredById String?
  registeredBy   User?   @relation("RegisteredBy", fields: [registeredById], references: [id])

  createdAt DateTime @default(now())
}

model VerificationToken {
  id         String   @id @default(cuid())
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

model Settings {
  id                  String  @id @default(cuid())
  storeName           String  @default("گیم‌نت من")
  phoneNumber         String?
  address             String? @db.Text
  logoUrl             String?
  extraControllerRate Int     @default(10000)

  gameNetId String  @unique
  gameNet   GameNet @relation(fields: [gameNetId], references: [id], onDelete: Cascade)

  updatedAt DateTime @updatedAt
}

model Service {
  id        String   @id @default(cuid())
  name      String
  price     Int
  gameNetId String
  gameNet   GameNet  @relation(fields: [gameNetId], references: [id], onDelete: Cascade)

  sessionServices SessionService[]
  createdAt       DateTime         @default(now())
}

model SessionService {
  id        String      @id @default(cuid())
  sessionId String
  session   GameSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  quantity Int      @default(1)
  addedAt  DateTime @default(now())
}
